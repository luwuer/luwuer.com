server {
  # 使用 HTTP/2，需要 Nginx1.9.7 以上版本
  listen 443 ssl http2 default_server;

  # 开启HSTS，并设置有效期为“6307200秒”（6个月），包括子域名(根据情况可删掉)，预加载到浏览器缓存(根据情况可删掉)
  add_header Strict-Transport-Security "max-age=6307200; preload";
  # add_header Strict-Transport-Security "max-age=6307200; includeSubdomains; preload";
  # 禁止被嵌入框架
  add_header X-Frame-Options DENY;
  # 防止在IE9、Chrome和Safari中的MIME类型混淆攻击
  add_header X-Content-Type-Options nosniff;
  # ssl 证书
  ssl_certificate /etc/letsencrypt/live/www.luwuer.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/www.luwuer.com/privkey.pem;
  # OCSP Stapling 证书
  ssl_trusted_certificate /etc/letsencrypt/live/www.luwuer.com/chain.pem;
  # OCSP Stapling 开启，OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高TLS握手速度
  ssl_stapling_verify on;
  #OCSP Stapling 验证开启
  ssl_stapling on; 
  #用于查询OCSP服务器的DNS  
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  # DH-Key交换密钥文件位置
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
  # 指定协议 TLS
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
  # 加密套件,这里用了CloudFlare's Internet facing SSL cipher configuration
  ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
  # 由服务器协商最佳的加密算法
  ssl_prefer_server_ciphers on;

  server_name  ~^(\w+\.)?(luwuer\.com)$; # $1 = 'blog.' || 'img.' || '' || 'www.' ; $2 = 'luwuer.com'
  set $pre $1;
  if ($pre = 'www.') {
    set $pre '';
  }
  set $next $2;
  
  root /root/apps/$pre$next;

  location / {
    try_files $uri $uri/ /index.html;
    index index.html;
  }

  location ^~ /api/ {
    proxy_pass http://43.226.147.135:3000/;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
  
  # socket代理配置
  location /socket.io/ {
    # proxy_pass http://43.226.147.135:3000/socket.io/;
    proxy_pass http://43.226.147.135:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  # location /weibo/ {
  #     proxy_pass https://api.weibo.com/;
  # }

  include /etc/nginx/utils/cache.conf;
}

server {
  listen 80;
  server_name www.luwuer.com;
  rewrite ^(.*)$ https://$server_name$request_uri;
}
